<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>@Sign_in_music Twitter archive</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="wrapper">
    <div class="flex-wrap">
      <h1>Bienvenido al archivo de @Sign_in_music en Twitter</h1>
      <p>Aquí puedes encontrar mis tweets y obtener un enlace a una versión archivada. Esto no incluye las respuestas a otras personas en este archivo, por lo que se trata de tweets e hilos «independientes».</p>
      <div class="tweet">
        <p id="tabs">
          <button class="tab active" id="browse-tab" onclick="browseTab()">Navegar</button>
          <button class="tab" id="search-tab" onclick="searchTab()">Buscar</button>
        </p>
        <hr class="hr">
        <p id="loading">Loading search...</p>
        <div id="search" hidden>
          <input id="search-input" type="search" />
          <div id="sorting">
            Sort by:
            <button class="sort-button" onclick="sortResults('most-relevant')">most relevant</button> |
            <button class="sort-button" onclick="sortResults('oldest-first')">oldest first</button> |
            <button class="sort-button" onclick="sortResults('newest-first')">newest first</button> |
            <button class="sort-button" onclick="sortResults('most-popular')">most popular</button>
          </div>
          <div id="output"></div>
        </div>
        <div id="browse" hidden>
          <div id="browse-sort">
            Ordenar por:
            <button class="sort-button-browse" onclick="sortResults('oldest-first-browse')">más antiguos primero</button> |
            <button class="sort-button-browse" onclick="sortResults('newest-first-browse')">más nuevos primero</button> |
            <button class="sort-button" onclick="sortResults('most-popular-browse')">más populares</button>
          </div>
          <p id="paging">Página <input id="page-num" type="number" /> de <span id="page-total">...</span> </p>
          <div id="browse-output"></div>
        </div>
      </div>
      <p>This site was made with <a href="https://tinysubversions.com/twitter-archive/make-your-own/">this Twitter archiving tool</a>.</p>
    </div>
  </div>

  <!-- Scripts -->
  <script src="searchDocuments.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/nextapps-de/flexsearch@0.7.31/dist/flexsearch.bundle.js"></script>
  <script src="app.js"></script>

  <!-- YouTube Embed Script -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      browseTab();

      function embedYouTube() {
        const containers = document.querySelectorAll('.tweet, #output, #browse-output');
        containers.forEach(container => {
          const html = container.innerHTML;

          const updated = html
            .replace(/https:\/\/www\.youtube\.com\/watch\?v=([\w-]{11})([^\s<]*)/g, (_, id, extra) => {
              const params = new URLSearchParams(extra);
              const t = params.get("t") || params.get("start");
              const startParam = t ? `?start=${parseInt(t)}` : "";
              return `<div class="yt-container" data-id="${id}" data-start="${startParam}">
                <iframe src="https://www.youtube.com/embed/${id}${startParam}" allowfullscreen></iframe>
              </div>`;
            })
            .replace(/https:\/\/youtu\.be\/([\w-]{11})([^\s<]*)/g, (_, id, extra) => {
              const params = new URLSearchParams(extra);
              const t = params.get("t") || params.get("start");
              const startParam = t ? `?start=${parseInt(t)}` : "";
              return `<div class="yt-container" data-id="${id}" data-start="${startParam}">
                <iframe src="https://www.youtube.com/embed/${id}${startParam}" allowfullscreen></iframe>
              </div>`;
            });

          container.innerHTML = updated;
        });

        // Reemplazar iframe no cargables con enlace
        setTimeout(() => {
          const containers = document.querySelectorAll('.yt-container');
          containers.forEach(div => {
            const iframe = div.querySelector('iframe');
            setTimeout(() => {
              const height = iframe.clientHeight;
              if (height === 0) {
                const id = div.getAttribute('data-id');
                const start = div.getAttribute('data-start');
                const seconds = start ? start.replace("?start=", "") : "";
                const link = document.createElement('a');
                link.href = `https://www.youtube.com/watch?v=${id}${seconds ? `&t=${seconds}` : ""}`;
                link.textContent = `Ver en YouTube: https://www.youtube.com/watch?v=${id}${seconds ? `&t=${seconds}` : ""}`;
                link.target = "_blank";
                div.replaceWith(link);
              }
            }, 2000);
          });
        }, 500);
      }

      setTimeout(embedYouTube, 500);
    });
  </script>
</body>
</html>
